#! /usr/bin/env ruby

require 'stash'
require 'ar_persistence_config'

module Stash
  module HarvesterApp
    def self.start_application(options)
      app = Application.with_config_file(options.config_file)
      app.start(from_time: options.from_time, until_time: options.until_time)
    end

    begin
      options = Options.new(ARGV)
      puts Options::VERSION if options.show_version
      puts Options::HELP if options.show_help
      start_application(options) unless options.do_exit
    rescue => e
      puts e
      puts e.backtrace
      if e.cause
        puts 'Caused by:'
        puts e.cause
        puts e.cause.backtrace
      end
      puts Options::USAGE
    end
  end
end
